AWSTemplateFormatVersion: 2010-09-09
Description: GitLab workload

Parameters:
# Infra Parameters
  DomainName:
    Type: String
  CreateHostedZone:
    Type: String
    AllowedValues: [ 'Yes', 'No' ]
  CreateSslCertificate:
    Type: String
    AllowedValues: [ 'Yes', 'No' ]
  SslCertificateIssuerEmail:
    Type: String
  EnvironmentName:
    Type: String

# Network Parameters
  VPCID: 
    Type: 'AWS::EC2::VPC::Id'
  VPCCIDR:
    Type: String
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/(1[6-9]|2[0-8]))$
  PrivateSubnet1ID:
    Type: 'AWS::EC2::Subnet::Id'
  PrivateSubnet2ID:
    Type: 'AWS::EC2::Subnet::Id'
  PrivateSubnet3ID:
    Type: String
    Default: ''
  NodeGroupSecurityGroup: 
    Type: AWS::EC2::SecurityGroup::Id

# Cluster Parameters
  KubeClusterName:
    Type: String
  ConfigureContainerInsights:
    Type: String
    AllowedValues: [ 'Yes', 'No' ]
  ConfigureGrafana:
    Type: String
    AllowedValues: [ 'Yes', 'No' ]

# Databse Parameters
  DBName: 
    AllowedPattern: "[a-zA-Z0-9]*"
    MaxLength: "64"
    MinLength: "0"
    Type: String
  DBPraefectName: 
    AllowedPattern: "[a-zA-Z0-9]*"
    MaxLength: "64"
    MinLength: "0"
    Type: String    
  DBUserName: 
    AllowedPattern: "[a-zA-Z][a-zA-Z0-9]*"
    MaxLength: "16"
    MinLength: "1"
    Type: String
  DBUserPassword:
    AllowedPattern: >-
      ^(?=^.{8,255}$)(?=.*[a-z])(?=.*[A-Z])(?=.*\d)((?=.*[^A-Za-z0-9])(?!.*[@/"'])).*$
    MaxLength: "64"
    MinLength: "8"
    NoEcho: "True"
    Type: String
  DBPort:
    Type: Number
    MinValue: 1150
    MaxValue: 65535
  DBInstanceClass:
    Type: String

# Object Storage Parameters
  ObjectStorageSSEAlgorithm:
    Type: String
    AllowedValues: [ 'AES256', 'aws:kms' ]
  ObjectStorageKMSKeyID:
    Type: String

# Cache Parameters
  CacheMode:
    Type: String
    AllowedValues: [ 'BuiltIn', 'External' ]    
  CacheNodes:
    Type: Number
  CacheNodeType:
    Type: String

# SMTP Parameters
  SMTPDomain: 
    Type: String
    AllowedValues: [ 'Disabled', 'CreateNew', 'UseExisting' ]    
  SMTPHostName:
    Type: String
  SMTPPort:
    Type: Number
  SMTPUsername:
    Type: String
  SMTPPassword:
    Type: String
  DefaultSESPort:
    Type: Number
    Default: 587

# GitLab Parameters
  HelmChartNamespaceCreate:
    Type: String
    AllowedValues: [ 'CreateNew', 'UseExisting' ]
  HelmChartNamespace:
    Type: String
  HelmChartName:
    Type: String
  HelmChartVersion:
    Type: String
  BackupSchedule:
    Type: String
  BackupVolumeSize:
    Type: Number
  NumberOfPraefectReplicas: 
    Type: Number
  NumberOfGitalyReplicas:
    Type: Number
  GitalyVolumeSize: 
    Type: Number

# Quickstart location Parameters
  QSS3BucketName:
    Type: String
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    Default: aws-quickstart
  QSS3BucketRegion:
    Type: String
    Default: 'us-east-1'
  QSS3KeyPrefix:
    Type: String
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    Default: quickstart-examples/

Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
  ConfigureContainerInsights: !Equals [!Ref ConfigureContainerInsights, 'Yes']
  ConfigureGrafana: !Equals [!Ref ConfigureGrafana, 'Yes']
  OutgoingEmailEnabled: !Not [!Equals [!Ref SMTPDomain, 'Disabled']]
  CreateEmailDomain: !Equals [!Ref SMTPDomain, 'CreateNew']
  CreateHostedZone: !Equals [!Ref CreateHostedZone, 'Yes']
  AcmIngressConfigured: !And [!Equals [!Ref CreateHostedZone, 'Yes'], !Equals [!Ref CreateSslCertificate, 'Yes']] 
  HelmChartNamespaceCreate: !Equals [!Ref HelmChartNamespaceCreate, 'CreateNew']
  CreateCacheCluster: !Equals [!Ref CacheMode, 'External']

Mappings: 
  PartitionMap: 
    aws:
      IngressImageRepository: k8s.gcr.io/defaultbackend-amd64
    aws-cn:
      IngressImageRepository: registry.aliyuncs.com/google_containers/defaultbackend

Resources:

  Functions: 
    Type: AWS::CloudFormation::Stack
    Properties: 
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-functions-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters: 
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  Telemetry: 
    Type: AWS::CloudFormation::Stack
    Condition: ConfigureContainerInsights
    Properties: 
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-telemetry-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters: 
        ClusterName: !Ref KubeClusterName

  Infrastructure:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-infra-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        VPCID: !Ref VPCID
        DBPort: !Ref DBPort
        DBAccessCIDR: !Ref VPCCIDR
        DomainName: !Ref DomainName
        CreateHostedZone: !Ref CreateHostedZone
        CreateEmailDomain: !If [CreateEmailDomain, 'Yes', 'No'] 
        CreateSslCertificate: !Ref CreateSslCertificate
        FunctionsBucketName: !GetAtt Functions.Outputs.FunctionsBucketName
        QSS3BucketName: !Ref QSS3BucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        QSS3BucketRegion: !Ref QSS3BucketRegion
        EnvironmentName: !Ref EnvironmentName

  Cache:
    Type: AWS::CloudFormation::Stack
    Condition: CreateCacheCluster
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-cache-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        VPCID: !Ref VPCID
        Subnet1ID: !Ref PrivateSubnet1ID
        Subnet2ID: !Ref PrivateSubnet2ID
        Subnet3ID: !Ref PrivateSubnet3ID
        IngressSecurityGroup: !Ref NodeGroupSecurityGroup
        CacheNodes: !Ref CacheNodes
        CacheNodeType: !Ref CacheNodeType

  Database:
    Type: AWS::CloudFormation::Stack
    # E9101 Ignoring 'master' in Aurora PostgreSQL quickstart parameter names
    Metadata: { cfn-lint: { config: { ignore_checks: [E9101] } } }
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/quickstart-amazon-aurora-postgresql/templates/aurora_postgres.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        DBEngineVersion: 11.7 # GitLab requires >= 11
        DBInstanceClass: !Ref DBInstanceClass
        DBName: !Ref DBName
        DBMasterUsername: !Ref DBUserName
        DBMasterUserPassword: !Ref DBUserPassword
        DBPort: !Ref DBPort
        VPCID: !Ref VPCID
        Subnet1ID: !Ref PrivateSubnet1ID
        Subnet2ID: !Ref PrivateSubnet2ID
        CustomDBSecurityGroup: !GetAtt Infrastructure.Outputs.DatabaseSecurityGroupID

  PraefectDatabase:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-praefect-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        DBHost: !GetAtt Database.Outputs.RDSEndPointAddress
        DBName: !Ref DBPraefectName
        DBUserName: !Ref DBUserName
        DBUserPassword: !Ref DBUserPassword
        DBPrivateSubnet1ID: !Ref PrivateSubnet1ID
        DBPrivateSubnet2ID: !Ref PrivateSubnet2ID
        DBSecurityGroup: !GetAtt Infrastructure.Outputs.DatabaseSecurityGroupID
        FunctionsBucketName: !GetAtt Functions.Outputs.FunctionsBucketName
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  ObjectStorage:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-storage-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SSEAlgorithm: !Ref ObjectStorageSSEAlgorithm
        KMSKeyID: !Ref ObjectStorageKMSKeyID
        EnvironmentName: !Ref EnvironmentName

  ChartNamespace:
    Type: AWSQS::Kubernetes::Resource
    Condition: HelmChartNamespaceCreate
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    # E3001 Invalid or unsupported Type AWSQS::Kubernetes::Resource
    Metadata: { cfn-lint: { config: { ignore_checks: [E3001] } } }
    Properties:
      ClusterName: !Ref KubeClusterName
      Manifest: !Sub |
        apiVersion: v1
        kind: Namespace
        metadata:
          name: ${HelmChartNamespace}
          labels:
            name: ${HelmChartNamespace}

  NewChartNamespaceWaitHandle: 
    Type: AWS::CloudFormation::WaitConditionHandle
    Condition: HelmChartNamespaceCreate
    DependsOn: ChartNamespace

  ExistingChartNamespaceWaitHandle: 
    Type: AWS::CloudFormation::WaitConditionHandle

  ChartNamespaceWaitCondition: 
    Type: AWS::CloudFormation::WaitCondition
    Properties: 
      Handle: !If [HelmChartNamespaceCreate, !Ref NewChartNamespaceWaitHandle, !Ref ExistingChartNamespaceWaitHandle]
      Timeout: '1'
      Count: 0

  KubeSecrets:
    Type: AWS::CloudFormation::Stack
    DependsOn: [Database, ChartNamespaceWaitCondition]
    Metadata: { cfn-lint: { config: { ignore_checks: [E1010] } } }
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-secrets-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        KubeClusterName: !Ref KubeClusterName
        HelmChartNamespace: !Ref HelmChartNamespace
        DatabasePassword: !Ref DBUserPassword
        StorageAccessKeyId: !Sub '{{resolve:secretsmanager:${ObjectStorage.Outputs.CredentialsSecretName}:SecretString:accessKeyId}}'
        StorageSecretAccessKey: !Sub '{{resolve:secretsmanager:${ObjectStorage.Outputs.CredentialsSecretName}:SecretString:secretAccessKey}}'
        RegistryBucket: !GetAtt ObjectStorage.Outputs.RegistryBucket
        SmtpPassword: !If
          - CreateEmailDomain
          - !Sub '{{resolve:secretsmanager:${Infrastructure.Outputs.SmtpCredentialsSecretName}:SecretString:password}}'
          - !If [OutgoingEmailEnabled, !Ref SMTPPassword, '']

  Chart:
    Type: AWSQS::Kubernetes::Helm   
    DependsOn: PraefectDatabase
    # E3001 Invalid or unsupported Type AWSQS::Kubernetes::Helm
    Metadata: { cfn-lint: { config: { ignore_checks: [E3001, E1010] } } }
    Properties:
      ClusterID: !Ref KubeClusterName 
      Namespace: !Ref HelmChartNamespace  
      Repository: https://charts.gitlab.io/
      Chart: gitlab/gitlab 
      Name: !Ref HelmChartName
      Version: !Ref HelmChartVersion
      Values:

        # domain name
        global.hosts.domain: !Ref DomainName

        # SSL support
        certmanager.install: !If [AcmIngressConfigured, false, true]
        certmanager-issuer.email: !If [AcmIngressConfigured, !Ref 'AWS::NoValue', !Ref SslCertificateIssuerEmail]
        global.ingress.configureCertmanager: !If [AcmIngressConfigured, false, true]

        global.ingress.enabled: !If [AcmIngressConfigured, false, true]
        nginx-ingress.defaultBackend.image.repository: 
          !FindInMap [PartitionMap, !Ref 'AWS::Partition', IngressImageRepository]
        nginx-ingress.controller.service.annotations.service.beta.kubernetes.io/aws-load-balancer-ssl-ports: 
          !If [AcmIngressConfigured, '443', !Ref 'AWS::NoValue']
        nginx-ingress.controller.service.annotations.service.beta.kubernetes.io/aws-load-balancer-backend-protocol:
          !If [AcmIngressConfigured, 'ssl', !Ref 'AWS::NoValue']
        nginx-ingress.controller.service.annotations.service.beta.kubernetes.io/aws-load-balancer-ssl-cert: 
          !If [AcmIngressConfigured, !GetAtt Infrastructure.Outputs.SslCertificateArn, !Ref 'AWS::NoValue']

        # telemetry configuration
        global.grafana.enabled: !If [ConfigureGrafana, true, false]

        # email configuration
        global.email.display_name: GitLab
        global.email.from: !Sub 'gitlab@${DomainName}'
        global.email.reply_to: !Sub 'noreply@${DomainName}'
        global.smtp.enabled: !If [OutgoingEmailEnabled, true, false] 
        global.smtp.domain: !Ref DomainName
        global.smtp.starttls_auto: true
        global.smtp.authentication: login
        global.smtp.address: 
          !If [CreateEmailDomain, !Sub 'email-smtp.${AWS::Region}.amazonaws.com', !Ref SMTPHostName]
        global.smtp.port: 
          !If [CreateEmailDomain, !Ref DefaultSESPort, !Ref SMTPPort]
        global.smtp.user_name: 
          !If [CreateEmailDomain, !Sub '{{resolve:secretsmanager:${Infrastructure.Outputs.SmtpCredentialsSecretName}:SecretString:username}}', !Ref SMTPUsername]
        global.smtp.password.secret: 
          !If [OutgoingEmailEnabled, !GetAtt KubeSecrets.Outputs.SmtpSecretName, !Ref 'AWS::NoValue'] 
        global.smtp.password.key: 
          !If [OutgoingEmailEnabled, !GetAtt KubeSecrets.Outputs.SmtpSecretKey, !Ref 'AWS::NoValue'] 

        # runner configuration
        gitlab-runner.install: false

        # cache configuration
        ## external redis settings
        redis.install: 
          !If [CreateCacheCluster, false, true]
        global.redis.host: 
          !If [CreateCacheCluster, !GetAtt Cache.Outputs.CacheEndpoint, !Ref 'AWS::NoValue']
        global.redis.password.enabled: false
        ## built-in redis settings
        redis.cluster.enabled:
          !If [CreateCacheCluster, !Ref 'AWS::NoValue', true]
        redis.cluster.slaveCount:
          !If [CreateCacheCluster, !Ref 'AWS::NoValue', !Ref CacheNodes]

        # database configuration
        postgresql.install: false
        global.psql.host: !GetAtt Database.Outputs.RDSEndPointAddress
        global.psql.database: !Ref DBName
        global.psql.username: !Ref DBUserName
        global.psql.password.secret: !GetAtt KubeSecrets.Outputs.DatabaseKubeSecretName
        global.psql.password.key: !GetAtt KubeSecrets.Outputs.DatabaseSecretKey

        # Praefect/Gitaly configuration
        # https://docs.gitlab.com/charts/charts/gitlab/praefect/
        global.praefect.enabled: true
        gitlab.praefect.replicas: !Ref NumberOfPraefectReplicas
        global.praefect.gitalyReplicas: !Ref NumberOfGitalyReplicas
        global.praefect.dbSecret.secret: !GetAtt KubeSecrets.Outputs.DatabaseKubeSecretName
        global.praefect.dbSecret.key: !GetAtt KubeSecrets.Outputs.DatabaseSecretKey
        global.praefect.psql.host: !GetAtt Database.Outputs.RDSEndPointAddress
        global.praefect.psql.user: !Ref DBUserName
        global.praefect.psql.dbName: !Ref DBPraefectName
        # https://docs.gitlab.com/charts/charts/gitlab/gitaly/ 
        gitlab.gitaly.persistence.enabled: true
        gitlab.gitaly.persistence.storageClass: gp2
        gitlab.gitaly.persistence.size: !Sub '${GitalyVolumeSize}Gi'
  
        # S3 storage configuration
        ## object storage
        global.minio.enabled: false
        global.appConfig.object_store.enabled: true
        global.appConfig.object_store.proxy_download: true
        global.appConfig.object_store.storage_options.server_side_encryption: AES256
        global.appConfig.object_store.connection.secret: !GetAtt KubeSecrets.Outputs.ObjectStorageKubeSecretName
        global.appConfig.object_store.connection.key: !GetAtt KubeSecrets.Outputs.ConnectionSecretKey
        global.appConfig.artifacts.bucket: !GetAtt ObjectStorage.Outputs.ArtifactsBucket
        global.appConfig.lfs.bucket: !GetAtt ObjectStorage.Outputs.LfsBucket
        global.appConfig.uploads.bucket: !GetAtt ObjectStorage.Outputs.UploadsBucket
        global.appConfig.packages.bucket: !GetAtt ObjectStorage.Outputs.PackagesBucket
        global.appConfig.terraformState.bucket: !GetAtt ObjectStorage.Outputs.TerraformBucket
        global.appConfig.pseudonymizer.bucket: !GetAtt ObjectStorage.Outputs.PseudonymizerBucket
        global.appConfig.backups.bucket: !GetAtt ObjectStorage.Outputs.BackupBucket
        global.appConfig.backups.tmpBucket: !GetAtt ObjectStorage.Outputs.BackupTempBucket
        ## registry
        global.registry.bucket: !GetAtt ObjectStorage.Outputs.RegistryBucket
        registry.storage.secret: !GetAtt KubeSecrets.Outputs.ObjectStorageKubeSecretName
        registry.storage.key: !GetAtt KubeSecrets.Outputs.RegistrySecretKey

        # backups, see https://docs.gitlab.com/charts/backup-restore/backup.html
        gitlab.task-runner.persistance.enabled: true
        gitlab.task-runner.persistance.storageClass: gp2
        gitlab.task-runner.persistance.size: !Sub '${BackupVolumeSize}Gi'
        gitlab.task-runner.backups.cron.enabled: true
        gitlab.task-runner.backups.cron.schedule: !Sub '${BackupSchedule}'
        gitlab.task-runner.backups.cron.extraArgs: '--skip registry --skip uploads --skip artifacts --skip lfs --skip packages --skip terraform_state'
        gitlab.task-runner.backups.cron.persistance.enabled: true
        gitlab.task-runner.backups.cron.persistance.storageClass: gp2
        gitlab.task-runner.backups.cron.persistance.size: !Sub '${BackupVolumeSize}Gi'
        gitlab.task-runner.backups.objectStorage.config.secret: !GetAtt KubeSecrets.Outputs.ObjectStorageKubeSecretName
        gitlab.task-runner.backups.objectStorage.config.key: !GetAtt KubeSecrets.Outputs.BackupSecretKey

        # Enable large project imports
        # https://gitlab.com/gitlab-org/charts/gitlab/-/issues/2151
        gitlab.webservice.ingress.proxyBodySize: 1024m
        gitlab.webservice.ingress.annotations.nginx.ingress.kubernetes.io/proxy-body-size: 1024m

  PostInstall: 
    Type: AWS::CloudFormation::Stack
    DependsOn: Chart
    Properties: 
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/workload/gitlab-postinstall-template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters: 
        ClusterName: !Ref KubeClusterName
        HelmChartNamespace: !Ref HelmChartNamespace
        HelmChartName: !Ref HelmChartName
        DomainName: !Ref DomainName
        HostedZoneId: !If [CreateHostedZone, !GetAtt Infrastructure.Outputs.HostedZoneId, '']
        EnvironmentName: !Ref EnvironmentName